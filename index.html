<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>MINE-THE-GAP Explore</title>
    <meta name="description" content="Where, when, what, and how much is mined. Research by Victor Maus.">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Sans:ital,wght@0,300;0,400;0,500;0,700;1,300&family=Montserrat:ital,wght@0,300;0,400;0,500;0,700;1,300&display=swap" rel="stylesheet">

    <!-- Leaflet & GeoTIFF.js -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/geotiff"></script>

    <!-- Custom MINE-THE-GAP Styles -->
    <link rel="stylesheet" href="https://minethegap.eu/assets/css/mtg.css" />
    <!-- <link rel="stylesheet" href="/assets/css/mtg.css" /> -->
    <script src="https://minethegap.eu/assets/js/header.js" defer></script>
    <link rel="stylesheet" href="assets/css/mtg-explorer.css" />

</head>
<body>

    <!-- Reusable Header Tag -->
    <project-header></project-header>

<div id="ui-panel">
    <div class="panel-title">
        Global Mining Land Use
        <button class="info-btn" onclick="toggleModal(true)">?</button>
    </div>
    <select id="layer-select"><option>Initializing...</option></select>
    
    <div class="legend">
        <div class="legend-item"><div class="swatch" style="background: #FFFFCC;"></div> < 5</div>
        <div class="legend-item"><div class="swatch" style="background: #FFEDA0;"></div> 5-20</div>
        <div class="legend-item"><div class="swatch" style="background: #FED976;"></div> 20-50</div>
        <div class="legend-item"><div class="swatch" style="background: #FEB24C;"></div> 50-100</div>
        <div class="legend-item"><div class="swatch" style="background: #FD8D3C;"></div> 100-250</div>
        <div class="legend-item"><div class="swatch" style="background: #F03B20;"></div> 250-500</div>
        <div class="legend-item"><div class="swatch" style="background: #BD0026;"></div> > 500</div>
        <div class="legend-item" style="font-style: italic; opacity: 0.6;">km²</div>
    </div>

    <div id="pixel-info">
        <div style="color: #70757a; font-style: italic; font-size: 11px; line-height: 1.4;">
            Click on the map to sample material extraction areas.
        </div>
    </div>
</div>

<!-- Information Modal -->
<div id="modal-overlay">
    <div id="data-modal">
        <h2>Global Mining Land Use</h2>
        <p>This interactive map provides an overview of the mining area linked to the extraction of different materials globally. The area was calculated based on mining land use polygons with associated materials, including primary materials and byproducts.</p>
        
        <div class="warning-box">
            <strong>Important: Layers are not additive.</strong><br>
            The values for different material layers <u>cannot</u> be summed to calculate total mining area. In many locations, multiple materials are co-extracted from the same geographic area. Adding these values would result in significant double-counting.
        </div>
        
        <p><strong>Data license:</strong> <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a></p>

        <p><strong>Citation:</strong> Maus, V., et al. (2025). A data-driven approach to mapping global commodity-specific mining land-use. Journal of Cleaner Production 
            <a href="https://doi.org/10.1016/j.jclepro.2025.147437" target="_blank">10.1016/j.jclepro.2025.147437</a>
        </p>

        <div class="data-links">
            <p><a id="readme-link" href="#" target="_blank">View README</a></p>
            <p><a id="download-link" href="#" download>Download GeoTIFF file</a></p>
            <p>Direct access to Cloud Optimized GeoTIFF (COG):</p>
            <span id="cog-link-display" class="code-block">Loading...</span>
        </div>

        <div class="modal-close">
            <button class="btn-close" onclick="toggleModal(false)">Close</button>
        </div>
    </div>
</div>

<div id="map"></div>

<script>
    const DATA_VERSION = "20251227";
    const cogUrl = `assets/data/material_areas_km2-${DATA_VERSION}.tif`;
    const readmeUrl = `assets/data/material_areas_km2-${DATA_VERSION}.txt`;
    
    // Update Modal links on load
    document.getElementById('download-link').href = cogUrl;
    document.getElementById('readme-link').href = readmeUrl;
    document.getElementById('cog-link-display').innerText = `https://maps.minethegap.eu/${cogUrl}`;

    // Global state - initialized from metadata
    let NODATA = 65535;
    let materials = [];

    function toggleModal(show) {
        document.getElementById('modal-overlay').classList.toggle('active', show);
    }

    const map = L.map('map', { 
        center: [20, 0], 
        zoom: 2, 
        minZoom: 2, 
        maxZoom: 12, 
        zoomControl: false 
    });
    
    map.attributionControl.setPrefix('<a href="https://leafletjs.com">Leaflet</a>');
    L.control.zoom({ position: 'bottomright' }).addTo(map);

    // Define layers separately to ensure clean initialization
    const darkLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { 
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="https://carto.com/attributions">CARTO</a>' 
    });

    const satLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { 
        attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community' 
    });

    // Add default layer
    darkLayer.addTo(map);

    // Add Control
    const baseLayers = {
        "Dark Map": darkLayer,
        "Satellite": satLayer
    };
    L.control.layers(baseLayers, null, { position: 'topleft' }).addTo(map);

    map.on('baselayerchange', () => { if (rasterLayer) rasterLayer.bringToFront(); });

    let tiff, image, rasterLayer, currentBandData, width, height, origin, res, clickMarker;

    function parseGdalMetadata(xmlString) {
        if (!xmlString) return {};
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(xmlString, "text/xml");
        const items = xmlDoc.getElementsByTagName("Item");
        const meta = {};
        for (let i = 0; i < items.length; i++) {
            const name = items[i].getAttribute("name");
            const sample = items[i].getAttribute("sample");
            const text = items[i].textContent.trim();
            
            if (name === "DESCRIPTION" && sample !== null) {
                const idx = parseInt(sample);
                meta[idx] = text;
            } else if (name && name.startsWith("BAND_")) {
                const idx = parseInt(name.replace("BAND_", "")) - 1;
                meta[idx] = text;
            }
        }
        return meta;
    }

    async function initMapTool() {
        try {
            tiff = await GeoTIFF.fromUrl(cogUrl);
            image = await tiff.getImage();
            
            // Extract NODATA
            const gdalNoData = image.getGDALNoData();
            if (gdalNoData !== null) NODATA = gdalNoData;

            // Extract Band Labels
            const numBands = image.getSamplesPerPixel();
            const gdalMeta = image.fileDirectory.GDAL_METADATA;
            
            const descriptions = parseGdalMetadata(gdalMeta);
            materials = [];
            for (let i = 0; i < numBands; i++) {
                // Use metadata description, otherwise fallback to "Band X"
                materials.push(descriptions[i] || `Band ${i + 1}`);
            }

            width = image.getWidth(); 
            height = image.getHeight();
            origin = image.getOrigin(); 
            res = image.getResolution();

            const select = document.getElementById('layer-select');
            select.innerHTML = '';
            materials.forEach((m, i) => {
                const opt = document.createElement('option');
                opt.value = i; opt.innerText = m.replace(/_/g, ' ');
                select.appendChild(opt);
            });

            select.onchange = async (e) => {
                const bandIndex = parseInt(e.target.value);
                const raster = await image.readRasters({ samples: [bandIndex] });
                currentBandData = raster[0];
                if (rasterLayer) { rasterLayer.redraw(); rasterLayer.bringToFront(); }
            };

            const initialBand = await image.readRasters({ samples: [0] });
            currentBandData = initialBand[0];
            setupGridLayer();
            map.on('click', handleMapClick);
        } catch (err) { console.error("Initialization Error:", err); }
    }

    function setupGridLayer() {
        rasterLayer = L.gridLayer({ opacity: 0.85, zIndex: 1000 });
        rasterLayer.createTile = function(coords) {
            const tile = document.createElement('canvas');
            tile.width = tile.height = 256;
            const ctx = tile.getContext('2d');
            const imgData = ctx.createImageData(256, 256);
            for (let y = 0; y < 256; y++) {
                for (let x = 0; x < 256; x++) {
                    const p = map.unproject(coords.multiplyBy(256).add([x, y]), coords.z);
                    const rX = Math.floor((p.lng - origin[0]) / res[0]);
                    const rY = Math.floor((p.lat - origin[1]) / res[1]);
                    if (rX >= 0 && rX < width && rY >= 0 && rY < height) {
                        const val = currentBandData[rY * width + rX];
                        if (val !== NODATA && val > 0) {
                            const idx = (y * 256 + x) * 4;
                            let c;
                            if (val < 50) c = [255,255,204,180];
                            else if (val < 200) c = [255,237,160,200];
                            else if (val < 500) c = [254,217,118,220];
                            else if (val < 1000) c = [254,178,76,230];
                            else if (val < 2500) c = [253,141,60,240];
                            else if (val < 5000) c = [240,59,32,250];
                            else c = [189,0,38,255];
                            imgData.data[idx] = c[0]; imgData.data[idx+1] = c[1];
                            imgData.data[idx+2] = c[2]; imgData.data[idx+3] = c[3];
                        }
                    }
                }
            }
            ctx.putImageData(imgData, 0, 0);
            return tile;
        };
        rasterLayer.addTo(map).bringToFront();
    }

    async function handleMapClick(e) {
        if (clickMarker) map.removeLayer(clickMarker);
        clickMarker = L.marker(e.latlng).addTo(map);
        
        const info = document.getElementById('pixel-info');
        info.innerHTML = '<div style="color:#888; font-style:italic; padding: 10px 0;">Sampling layers...</div>';

        const rX = Math.floor((e.latlng.lng - origin[0]) / res[0]);
        const rY = Math.floor((e.latlng.lat - origin[1]) / res[1]);
        if (rX < 0 || rX >= width || rY < 0 || rY >= height) return;

        const fullImage = await tiff.getImage(0);
        const pixelSample = await fullImage.readRasters({ window: [rX, rY, rX + 1, rY + 1] });
        let html = ""; let foundAny = false;
        materials.forEach((m, i) => {
            const val = pixelSample[i][0];
            if (val !== NODATA && val > 0) {
                foundAny = true;
                html += `<div class="val-row"><span>${m.replace(/_/g, ' ')}</span><span>${(val/10).toFixed(1)} km²</span></div>`;
            }
        });
        info.innerHTML = foundAny ? html : "No mining detected.";
    }

    window.onload = initMapTool;
</script>

</body>
</html>